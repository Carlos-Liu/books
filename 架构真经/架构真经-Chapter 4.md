# 先利其器

#### 马斯洛的锤子
- 我们都试图使用*自己熟悉的工具*来解决当前的问题
- 我们解决问题时有可能会选择不适当或不理想的工具或解决方案  
e.g. 使用文件系统就可以解决的，就不要使用数据库

#### 两位技术高管的建议
詹姆斯 （eBay, PayPal CTO)  
- 在合适的时间，为合适的工作选取合适的工具 （需要判断力以及进行权衡）
- 不要过度使用工具 （用企业级数据库解决一切问题 -> 成本增加）
- 拿出一部分资源来主动分析、试验和采用新技术
- 拥有核心工具的团队时采用新进步和新技术创新的团队  

克里斯 （ObjectRocket创始人）
- 要了解平台的副作用和需要做的取舍
- 技术的多样性，数据增长显著加快，工具取舍错误可能会*毁灭*一个企业
- 要进行多样性的技术储备，考虑如何将数据扩展1000倍
- 选取工具时要考虑可扩展性，e.g. 第一个百万客户，AO, 5 years | eBay, 3 years | Instagram 9 weeks
- 没有完美的数据库，没有完美的数据存储 （取舍）

|  | 关系型数据库 |非关系型数据库
| - | :-: | -: 
| 数据规模 |  |  x 2
| 灵活性 | | V  
|数据查询、分析|V|

## Rule 14: 适当使用数据库 
内容：当需要ACID属性来保持数据之间的关系和一致性时，可使用关系型数据库。其它数据的存储需要考虑**更合适**的工具，如NoSQL，DBMS。  
场景：在系统架构中引入新数据或者数据结构时.  
用法：考虑数据量、存储量、响应时间、关系和其它因素来选择合适的存储工具。也要考虑数据结构以及**产品需要对数据进行的管理和操作**。  
原因：关系型数据库提供了高度的事物完整性，但成本也高，难以扩展，而其与其它许多可选的存储系统相比可用性较低。  
要点：使用合适的数据存储工具。  

#### 关系型数据库管理系统
优势  
- 通过ACID属性保持事物的完整性
- 表内部和表之间的关系结构  

局限性  
- 扩展性更具挑战  (主键、外键、保证数据一致性)
- 通过分库、分表操作来拆分数据库变得困难 （表内部、表之间的关系）  

#### 什么时候选择关系型数据库？
- 需要事物完整性或与其他数据的关系

#### 数据存储系统
- 文件系统： 写一次，读多次。GFS,MogileFS, Ceph. 
- [NoSQL](https://baike.baidu.com/item/NoSQL/8828247?fr=aladdin) 
     - 对实体或对象之间的关系的数量有所限制  
分类  
  - 键值存储：Memcached,Redis，Amazon DymamoDB, Simple DB. 对数据做单一的键值索引，存储在内存中。同步复制/异步复制保持一致性。    
  - 可扩展记录存储(ERS)/宽列存储：Google Bigtable，**Facebook Cassandra**，HBase。异步复制保持一致性。  
  - 文档存储：MongoDB, CouchDB, Amazon DynamoDB, Couchbase。异步复制保持一致性。  

NoSQL数据库没有标准的查询语言(SQL)，因此进行数据库查询需要制定数据模型。许多NoSQL数据库都有REST式的数据接口或者查询API。如：Neo4J, InfoGrid, Infinite Graph.  
因此，我们总结NoSQL数据库在以下的这几种情况下比较适用：   
1、数据模型比较简单；  
2、需要灵活性更强的IT系统；  
3、对数据库性能要求较高；  
4、不需要高度的数据一致性；  
5、对于给定key，比较容易映射复杂值的环境。  

NoSQL数据库并没有一个统一的架构，两种NoSQL数据库之间的不同，甚至远远超过两种关系型数据库的不同。可以说，NoSQL各有所长，**成功的NoSQL必然特别适用于某些场合或者某些应用，在这些场合中会远远胜过关系型数据库和其他的NoSQL。**

#### MapReduce (Google)
- Map：输入：键值对；输出：Reducer
- Reduce：按键进行排序和分组

  
扩展的成本、局限性与实体之间关联度的关系  
![](https://github.com/Carlos-Liu/Images/blob/master/%E6%9E%B6%E6%9E%84%E7%9C%9F%E7%BB%8F/db1.png)   

与灵活性的相对关系  
![](https://github.com/Carlos-Liu/Images/blob/master/%E6%9E%B6%E6%9E%84%E7%9C%9F%E7%BB%8F/db2.png)  


### 选择数据存储系统需要考虑  
- 数据之间的关联度 *-> 系统的灵活性、复杂度、成本、研发时间*
- 方案的成长速度（预期增长率）*-> 系统成本、对用户的响应时间* -> 高关联度可能需要进行拆分
- 数据读写的比率（是否存在数据被潜在更新的可能）*-> 需要什么样的系统*
- 数据能带来多少效益 （系统成本 < 带来的价值）*-> 层次化地存储数据，将老化的数据转移到便宜且存取较慢的存储介质。原因：数据价值逐渐减少，保存成本逐渐增加*

解决方案决策立方体  
![](https://github.com/Carlos-Liu/Images/blob/master/%E6%9E%B6%E6%9E%84%E7%9C%9F%E7%BB%8F/solution%20decision%20cube.png)  

## Rule 15：慎重使用防火墙
内容: 只有在能显著降低风险时才使用防火墙。要认识到防火墙会导致可扩展性和可用性的问题。  
场景：总是。  
用法：可使用防火墙来满足关键的PII、PCI（支付卡行业）的合规性要求。不要用在低价值的静态内容的防护上。  
原因：防火墙会**降低可用性**，并引起可扩展性瓶颈。  
要点：防火墙虽然有用，但常被滥用，设计和实施不当会带来可用性和可扩展性问题。  

- 采取安全措施的决策应当最终能经得起**利润最大化**的考验。   
- 安全是降低风险的举措
- 风险是事件发生的概率及其如果发生可能带来的影响（破坏）的函数
- 防火墙失败是第二大网站瘫痪黑手
- **引入任何多余的网络节点，无论如何实施，都会增加网络的延迟时间，降低系统的可用性**

#### 防火墙  
- 降低事件发生的概率
- 在网络传输上增加“一跳” ([Network Hop](https://en.wikipedia.org/wiki/Hop_(networking)))
- 购买成本,需要额外的资本支出
- 影响可用性-> 影响客户满意度
- 带来可扩展性的问题，在网络或者交易流量上出现扩展瓶颈

不是所有的区域都要上锁  
![](http://uclachoralmusic.com/wp-content/uploads/2017/10/home-garden-design-plan-room-the.jpg)

实施防火墙的决策矩阵  
![](https://github.com/Carlos-Liu/Images/blob/master/%E6%9E%B6%E6%9E%84%E7%9C%9F%E7%BB%8F/firewall%20matrics.png)

- 对于价值低的资产防护，可以部署在内网IP空间，而且只能通过端口80和443进行访问

- 每个泳道部署自己的防火墙和负载均衡器 -> 故障影响最小化

## Rule 16: 积极使用日志文件
内容：使用应用日志文件来诊断和预防问题。   
场景：制定监控日志文件的过程，迫使人们对发现的问题采取行动。  
用法：使用任何监控工具，从自定义脚本到Splunk或ELK框架，监视应用日志中的错误。导出这些错误信息，然后安排资源去确定和解决问题。  
原因：日志文件是有关应用执行的绝好的信息来源，不要轻易放弃。  
要点：若充分利用好日志文件，生产问题将越来越少，且当问题出现时可迅速定位解决。

使日志得到最佳应用遵循以下重要步骤
1. 数据聚合    
数据多到无法防在一起该怎么办？   
     - 数据抽样    
     - 分步聚合    
     ![](https://github.com/Carlos-Liu/Images/blob/master/%E6%9E%B6%E6%9E%84%E7%9C%9F%E7%BB%8F/log%20agg.png)   
     
数据聚合一般通过独立的网络完成，不走生产流量相关的网络  
- 可以考虑使用多网卡，App server写log时走另外一个网卡
- App server的log写到独立的Log服务器上

2. 监控
使用自动化工具监控这些文件  
- Splunk
- ELK    
 > Logstash从不同的输入（日志文件）中**抽取**数据，进行格式转换 -> Elasticsearch分布式的数据存储和搜索引擎 (大数据索引、查询) -> Kibana可视化的实时监控工具，设置警报线

3. 采取行动解决问题

* 确保日志不会急速增长以致失控
* 确保日志不会被忽视
* 对不需要采取action的错误进行定期清理
* 日志有代价：保持数据的成本 + 事物处理响应时间的代价。随着时间推移，数据的价值降低    
               - 可通过日志汇总、归档、清楚来降低存储成本    
               - 异步方式记录日志降低对事物处理响应时间的影响  
